<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Ticket JIRA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: #0052cc;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .form-section {
            padding: 30px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0052cc;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: #0052cc;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: #003d99;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-right: 10px;
            width: auto;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            height: 4px;
            background: #e1e5e9;
            border-radius: 2px;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: #0052cc;
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 50%;
        }

        .help-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .config-preview {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .config-item:last-child {
            margin-bottom: 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0052cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .required {
            color: #dc3545;
        }

        .ticket-link {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .ticket-link a {
            color: #1976d2;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
        }

        .ticket-link a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .btn-group {
                flex-direction: column;
            }

            .btn-secondary {
                margin-right: 0;
                margin-bottom: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎫 Crear Ticket JIRA</h1>
            <p>Configura tu conexión y crea tickets fácilmente</p>
        </div>

        <div class="form-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <!-- Paso 1: Configuración -->
            <div id="step1" class="step active">
                <h2 style="margin-bottom: 20px; color: #333;">Configuración de JIRA</h2>

                <div class="form-group">
                    <label for="jiraUrl">URL de JIRA <span class="required">*</span></label>
                    <input type="url" id="jiraUrl" placeholder="https://tuempresa.atlassian.net" required>
                    <div class="help-text">La URL completa de tu instancia de JIRA Cloud</div>
                </div>

                <div class="form-group">
                    <label for="userEmail">Email del usuario <span class="required">*</span></label>
                    <input type="email" id="userEmail" placeholder="tu@email.com" required>
                    <div class="help-text">Tu email registrado en JIRA</div>
                </div>

                <div class="form-group">
                    <label for="apiToken">API Token <span class="required">*</span></label>
                    <input type="password" id="apiToken" placeholder="Tu API Token de JIRA" required>
                    <div class="help-text">
                        <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" style="color: #0052cc;">
                            Generar API Token aquí
                        </a>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectKey">Clave del Proyecto <span class="required">*</span></label>
                    <input type="text" id="projectKey" placeholder="PROJ" required style="text-transform: uppercase;">
                    <div class="help-text">Clave del proyecto donde se creará el ticket (ej: TEST, PROJ)</div>
                </div>

                <button type="button" class="btn" onclick="testConnection()">
                    <span id="testBtnText">Probar Conexión y Continuar</span>
                </button>
            </div>

            <!-- Paso 2: Crear Ticket -->
            <div id="step2" class="step">
                <h2 style="margin-bottom: 20px; color: #333;">Crear Nuevo Ticket</h2>

                <div class="config-preview">
                    <h4 style="margin-bottom: 10px;">Configuración Actual:</h4>
                    <div class="config-item">
                        <span><strong>JIRA:</strong></span>
                        <span id="configUrl"></span>
                    </div>
                    <div class="config-item">
                        <span><strong>Usuario:</strong></span>
                        <span id="configEmail"></span>
                    </div>
                    <div class="config-item">
                        <span><strong>Proyecto:</strong></span>
                        <span id="configProject"></span>
                    </div>
                </div>

                <form id="ticketForm">
                    <div class="form-group">
                        <label for="issueType">Tipo de Issue <span class="required">*</span></label>
                        <select id="issueType" required>
                            <option value="">Cargando tipos de issue...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority">Prioridad</label>
                        <select id="priority">
                            <option value="">Seleccionar prioridad...</option>
                            <option value="1">Highest</option>
                            <option value="2">High</option>
                            <option value="3">Medium</option>
                            <option value="4">Low</option>
                            <option value="5">Lowest</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="summary">Resumen <span class="required">*</span></label>
                        <input type="text" id="summary" placeholder="Breve descripción del problema o tarea" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripción</label>
                        <textarea id="description" placeholder="Descripción detallada del ticket..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="labels">Labels (separadas por comas)</label>
                        <input type="text" id="labels" placeholder="frontend, urgente, bug">
                        <div class="help-text">Etiquetas opcionales para categorizar el ticket</div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep1()">
                            ← Volver a Configuración
                        </button>
                        <button type="submit" class="btn">
                            <span id="submitBtnText">Crear Ticket</span>
                        </button>
                    </div>
                </form>

                <div id="ticketResult" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para la configuración
        let jiraConfig = {
            url: '',
            email: '',
            token: '',
            projectKey: ''
        };

        // Función para hacer peticiones al backend
        async function apiRequest(endpoint, data) {
            const response = await fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            return await response.json();
        }

        // Funciones de navegación
        function goToStep1() {
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('progressFill').style.width = '50%';
        }

        async function goToStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('progressFill').style.width = '100%';

            // Mostrar configuración actual
            document.getElementById('configUrl').textContent = jiraConfig.url;
            document.getElementById('configEmail').textContent = jiraConfig.email;
            document.getElementById('configProject').textContent = jiraConfig.projectKey;

            // Cargar tipos de issue
            await loadIssueTypes();
        }

        // Función para cargar tipos de issue disponibles
        async function loadIssueTypes() {
            try {
                const result = await apiRequest('issue-types', jiraConfig);
                const select = document.getElementById('issueType');

                if (result.success) {
                    select.innerHTML = '<option value="">Seleccionar tipo...</option>';
                    result.issueTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.name;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Error al cargar tipos</option>';
                    console.error('Error loading issue types:', result.message);
                }
            } catch (error) {
                console.error('Error loading issue types:', error);
                document.getElementById('issueType').innerHTML = '<option value="">Error al cargar tipos</option>';
            }
        }

        // Función para mostrar mensajes de estado
        function showMessage(message, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.innerHTML = message;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';

            // Auto-ocultar después de 5 segundos para mensajes de éxito
            if (type === 'success') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 8000);
            }
        }

        // Función para probar la conexión
        async function testConnection() {
            const url = document.getElementById('jiraUrl').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const token = document.getElementById('apiToken').value.trim();
            const projectKey = document.getElementById('projectKey').value.trim().toUpperCase();

            // Validación básica
            if (!url || !email || !token || !projectKey) {
                showMessage('Por favor, completa todos los campos requeridos.', 'error');
                return;
            }

            if (!url.includes('atlassian.net')) {
                showMessage('La URL debe ser una instancia de JIRA Cloud (*.atlassian.net)', 'error');
                return;
            }

            // Mostrar loading
            const testBtn = document.querySelector('#step1 .btn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span class="loading"></span>Probando conexión...';
            testBtn.disabled = true;

            try {
                // Probar conexión con el backend
                const result = await apiRequest('test-connection', {
                    url, email, token, projectKey
                });

                if (result.success) {
                    // Guardar configuración
                    jiraConfig = { url, email, token, projectKey };

                    showMessage(`✅ Conexión exitosa con el proyecto "${result.projectInfo.name}"`, 'success');

                    setTimeout(() => {
                        goToStep2();
                    }, 1500);
                } else {
                    showMessage(`❌ ${result.message}`, 'error');
                }

            } catch (error) {
                showMessage(`Error al probar la conexión: ${error.message}`, 'error');
                console.error('Connection test error:', error);
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Función para crear el ticket
        async function createTicket(ticketData) {
            return await apiRequest('create-ticket', {
                ...jiraConfig,
                ...ticketData
            });
        }

        // Manejar el envío del formulario
        document.getElementById('ticketForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span>Creando ticket...';
            submitBtn.disabled = true;

            try {
                // Recopilar datos del formulario
                const ticketData = {
                    issueType: document.getElementById('issueType').value,
                    priority: document.getElementById('priority').value,
                    summary: document.getElementById('summary').value,
                    description: document.getElementById('description').value,
                    labels: document.getElementById('labels').value.split(',').map(l => l.trim()).filter(l => l)
                };

                // Validación
                if (!ticketData.issueType || !ticketData.summary) {
                    showMessage('Por favor, completa los campos requeridos.', 'error');
                    return;
                }

                // Crear el ticket
                const result = await createTicket(ticketData);

                if (result.success) {
                    showMessage(`✅ Ticket creado exitosamente: ${result.ticket.key}`, 'success');

                    // Mostrar enlace al ticket
                    const ticketResult = document.getElementById('ticketResult');
                    ticketResult.innerHTML = `
                        <div class="ticket-link">
                            <p style="margin-bottom: 10px;">Ticket creado exitosamente:</p>
                            <a href="${result.ticket.url}" target="_blank">${result.ticket.key}</a>
                            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                                Haz clic para ver el ticket en JIRA
                            </p>
                        </div>
                    `;
                    ticketResult.style.display = 'block';

                    // Limpiar formulario
                    document.getElementById('ticketForm').reset();

                } else {
                    showMessage(`❌ Error al crear el ticket: ${result.message}`, 'error');
                }

            } catch (error) {
                showMessage(`Error al crear el ticket: ${error.message}`, 'error');
                console.error('Create ticket error:', error);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Convertir project key a mayúsculas automáticamente
        document.getElementById('projectKey').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Ocultar mensaje al cambiar de paso
        function hideMessage() {
            document.getElementById('statusMessage').style.display = 'none';
        }
    </script>
</body>
</html>