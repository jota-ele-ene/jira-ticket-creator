<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Ticket JIRA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            background: white; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 600px; width: 100%; overflow: hidden;
        }
        .header {
            background: #0052cc; color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .form-section { padding: 30px; }
        .step { display: none; }
        .step.active { display: block; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea {
            width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px;
            font-size: 16px; transition: border-color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0052cc; }
        textarea { resize: vertical; min-height: 120px; }
        .btn {
            background: #0052cc; color: white; border: none; padding: 15px 30px; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%;
        }
        .btn:hover { background: #003d99; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; margin-right: 10px; width: auto; }
        .btn-secondary:hover { background: #545b62; }
        .btn-group { display: flex; gap: 10px; justify-content: space-between; }
        .status-message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .progress-bar { height: 4px; background: #e1e5e9; border-radius: 2px; margin-bottom: 30px; }
        .progress-fill { height: 100%; background: #0052cc; border-radius: 2px; transition: width 0.3s ease; width: 50%; }
        .help-text { font-size: 14px; color: #666; margin-top: 5px; }
        .config-preview { background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .config-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .config-item:last-child { margin-bottom: 0; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3;
            border-top: 3px solid #0052cc; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .required { color: #dc3545; }
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: #0052cc; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        .navbar a { color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; background: rgba(255,255,255,0.2); }
        .navbar a:hover { background: rgba(255,255,255,0.3); }
        body { padding-top: 70px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <span>üé´ JIRA Ticket Creator</span>
        <a href="/inbox">üì¨ Ver Bandeja</a>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üé´ Crear Ticket JIRA</h1>
            <p>Configura tu conexi√≥n y crea tickets f√°cilmente</p>
        </div>

        <div class="form-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <!-- Paso 1: Configuraci√≥n -->
            <div id="step1" class="step active">
                <h2 style="margin-bottom: 20px; color: #333;">Configuraci√≥n de JIRA</h2>

                <div class="form-group">
                    <label for="jiraUrl">URL de JIRA <span class="required">*</span></label>
                    <input type="url" id="jiraUrl" placeholder="https://tuempresa.atlassian.net" required>
                    <div class="help-text">La URL completa de tu instancia de JIRA Cloud</div>
                </div>

                <div class="form-group">
                    <label for="userEmail">Email del usuario <span class="required">*</span></label>
                    <input type="email" id="userEmail" placeholder="tu@email.com" required>
                    <div class="help-text">Tu email registrado en JIRA</div>
                </div>

                <div class="form-group">
                    <label for="apiToken">API Token <span class="required">*</span></label>
                    <input type="password" id="apiToken" placeholder="Tu API Token de JIRA" required>
                    <div class="help-text">
                        <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" style="color: #0052cc;">
                            Generar API Token aqu√≠
                        </a>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectKey">Clave del Proyecto <span class="required">*</span></label>
                    <input type="text" id="projectKey" placeholder="PROJ" required style="text-transform: uppercase;">
                    <div class="help-text">Clave del proyecto donde se crear√° el ticket (ej: TEST, PROJ)</div>
                </div>

                <button type="button" class="btn" onclick="testConnection()">
                    <span id="testBtnText">Probar Conexi√≥n y Continuar</span>
                </button>
            </div>

            <!-- Paso 2: Crear Ticket -->
            <div id="step2" class="step">
                <h2 style="margin-bottom: 20px; color: #333;">Crear Nuevo Ticket</h2>

                <div class="config-preview">
                    <h4 style="margin-bottom: 10px;">Configuraci√≥n Actual:</h4>
                    <div class="config-item">
                        <span><strong>JIRA:</strong></span>
                        <span id="configUrl"></span>
                    </div>
                    <div class="config-item">
                        <span><strong>Usuario:</strong></span>
                        <span id="configEmail"></span>
                    </div>
                    <div class="config-item">
                        <span><strong>Proyecto:</strong></span>
                        <span id="configProject"></span>
                    </div>
                </div>

                <form id="ticketForm">
                    <div class="form-group">
                        <label for="issueType">Tipo de Issue <span class="required">*</span></label>
                        <select id="issueType" required>
                            <option value="">Cargando tipos de issue...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority">Prioridad</label>
                        <select id="priority">
                            <option value="">Seleccionar prioridad...</option>
                            <option value="1">Highest</option>
                            <option value="2">High</option>
                            <option value="3">Medium</option>
                            <option value="4">Low</option>
                            <option value="5">Lowest</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="summary">Resumen <span class="required">*</span></label>
                        <input type="text" id="summary" placeholder="Breve descripci√≥n del problema o tarea" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripci√≥n</label>
                        <textarea id="description" placeholder="Descripci√≥n detallada del ticket..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="labels">Labels (separadas por comas)</label>
                        <input type="text" id="labels" placeholder="frontend, urgente, bug">
                        <div class="help-text">Etiquetas opcionales para categorizar el ticket</div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep1()">
                            ‚Üê Volver a Configuraci√≥n
                        </button>
                        <button type="submit" class="btn">
                            <span id="submitBtnText">Crear Ticket</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let jiraConfig = {};

        function goToStep1() {
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('progressFill').style.width = '50%';
        }

        async function goToStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('progressFill').style.width = '100%';

            document.getElementById('configUrl').textContent = jiraConfig.url;
            document.getElementById('configEmail').textContent = jiraConfig.email;
            document.getElementById('configProject').textContent = jiraConfig.projectKey;

            await loadIssueTypes();
        }

        async function loadIssueTypes() {
            try {
                const result = await apiRequest('issue-types', jiraConfig);
                const select = document.getElementById('issueType');

                if (result.success) {
                    select.innerHTML = '<option value="">Seleccionar tipo...</option>';
                    result.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Error al cargar tipos</option>';
                }
            } catch (error) {
                document.getElementById('issueType').innerHTML = '<option value="">Error al cargar tipos</option>';
            }
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => messageEl.style.display = 'none', 5000);
            }
        }

        async function testConnection() {
            const url = document.getElementById('jiraUrl').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const token = document.getElementById('apiToken').value.trim();
            const projectKey = document.getElementById('projectKey').value.trim().toUpperCase();

            if (!url || !email || !token || !projectKey) {
                showMessage('Por favor, completa todos los campos requeridos.', 'error');
                return;
            }

            if (!url.includes('atlassian.net')) {
                showMessage('La URL debe ser una instancia de JIRA Cloud (*.atlassian.net)', 'error');
                return;
            }

            const testBtn = document.querySelector('#step1 .btn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span class="loading"></span>Probando conexi√≥n...';
            testBtn.disabled = true;

            try {
                const result = await apiRequest('test-connection', { url, email, token, projectKey });

                if (result.success) {
                    jiraConfig = { url, email, token, projectKey };
                    showMessage(`‚úÖ Conexi√≥n exitosa con el proyecto`, 'success');
                    setTimeout(() => goToStep2(), 1500);
                } else {
                    showMessage(`‚ùå ${result.message}`, 'error');
                }

            } catch (error) {
                showMessage(`Error al probar la conexi√≥n: ${error.message}`, 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        async function apiRequest(endpoint, data) {
            const response = await fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            return await response.json();
        }

        document.getElementById('ticketForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span>Creando ticket...';
            submitBtn.disabled = true;

            try {
                const ticketData = {
                    ...jiraConfig,
                    issueType: document.getElementById('issueType').value,
                    priority: document.getElementById('priority').value,
                    summary: document.getElementById('summary').value,
                    description: document.getElementById('description').value,
                    labels: document.getElementById('labels').value.split(',').map(l => l.trim()).filter(l => l)
                };

                if (!ticketData.issueType || !ticketData.summary) {
                    showMessage('Por favor, completa los campos requeridos.', 'error');
                    return;
                }

                const result = await apiRequest('create-ticket', ticketData);

                if (result.success) {
                    showMessage(`‚úÖ Ticket creado exitosamente: ${result.key}`, 'success');
                    document.getElementById('ticketForm').reset();
                } else {
                    showMessage(`‚ùå Error al crear el ticket: ${result.message}`, 'error');
                }

            } catch (error) {
                showMessage(`Error al crear el ticket: ${error.message}`, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        document.getElementById('projectKey').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
</body>
</html>